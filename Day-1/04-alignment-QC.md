# Part 3 - Pre-processing and quality control (QC) of raw data 

### Learning objectives: 
- Understand the FASTQ file format and the formatting sequence information it stores
- Learn how to perform basic operations on FASTQ files in the command-line 

## Quality-control of raw data 


### Post-alignment quality control 
Once you have aligned your reads, it is important to assess how well our reads could be mapped to the reference genome. The primary metric of a successful alignment is the **percentage of uniquely mapped reads**, and while this depends on the organism and reference genome you map to, a good quality sample is expected to have ~75% of its read uniquely mapped. As we did earlier, we can find this information, as well as the number of unmapped and multi-mapping reads, in the `final.out` file generated by STAR. 

```bash
cat x.final.out 
```  

However, there are several other valuable QC metrics that evaluate features of genome alignments and allow us to identify potential issues or biases that may exist in the data. These metrics include: 

- **Genomic context of reads**: We expect the majority of our reads to map in coding/UTR regions, with few reads in intronic or intergenic regions. If the proportion of intronic or intergenic reads is high, this could suggest your library is contaminated with genomic DNA, or the annotation provided for the reference genome is incomplete. 

- **Proportion of ribosomal RNA (rRNA) reads**: rRNA constituties the large majority of RNA present in most cell types, which are usually not of interest in or experiment, therefore we try to reduce their numbers using depletion and polyA slection procedures in library preparation. However, these procedures are not 100% effective. If the proportion of rRNA reads is high, you should filter these reads before differential expression analysis, as it may skew the normalization of your count matrix. 

- **Gene body coverage**: depending on the type of library protocol used, you will have an expectation for the average distribution of reads over gene bodies. For full-length transcript methods, you expect coverage over the entire body of a gene on average, however for 3'-end methods (e.g. QuantSeq) you expect a heavy 3' bias. Any significant deviations from expected can indicate sample quality problems that may be reflective of issues in library preparation. 

- **Strand specificity**: For stranded library-preparation protocols, we expect almost all the reads to come from the expected strand (e.g. *REV* for KAPA libraries, *FWD* for QuantSeq 3' libraries. For non-stranded protocols, the distribution of reads should be equally split between *FWD* and *REV*. 

[Picard tools](https://broadinstitute.github.io/picard/) (Star-trek) provides a useful tool, called [*CollectRNASeqMetrics*](https://gatk.broadinstitute.org/hc/en-us/articles/360037057492-CollectRnaSeqMetrics-Picard-) that calculates these metrics, taking the alignment SAM/BAM file as input, and returning a text file with the suffix `.output.RNA_Metrics`. 

To run CollectRNASeqMetrics on this dataset, we would run:
```bash 
java -jar picard.jar \
CollectRnaSeqMetrics \
I=input.bam \
O=output.RNA_Metrics \
REF_FLAT=ref_flat.txt \
STRAND=SECOND_READ_TRANSCRIPTION_STRAND \
RIBOSOMAL_INTERVALS=ribosomal.interval_list
```
**Option descriptions:**  
`I`=input aligned bam file  
`O`=output RNAseq metrics  
`REF_FLAT`=Gene annotations in refFlat form. Format described [here](http://genome.ucsc.edu/goldenPath/gbdDescriptionsOld.html#RefFlat)
`STRAND`= For strand-specific library prep. (e.g. use `FIRST_READ_TRANSCRIPTION_STRAND` if the reads are expected to be on the transcription strand, as in the 3'-end QuantSeq assay). 
`RIBOSOMAL_INTERVALS`= Location of rRNA sequences in genome, in interval_list format. If not specified no bases will be identified as being ribosomal. Format described [here](http://samtools.github.io/htsjdk/javadoc/htsjdk/htsjdk/samtools/util/IntervalList.html). 

```bash
cat x.output.RNA_Metrics 
```  

### Duplicates in RNA-seq 

Another feature of RNA-seq data quality that can be evaluated after alignment is the presence of duplicate reads. Library preparation for RNA-seq generally involves PCR amplification of the input material to  generate enough cDNA for sequencing. This PCR amplification can introduce bias into RNA-seq libraries as it is known that not all fragments are amplified as efficiently as others, and is affected by features such as GC content and fragment length. Furthermore, on certain Illumina sequencers, an independent type of duplicate can occur, called *optical duplicates*, where large clusters formed on the flowcell during sequencing are called as two separate clusters. 

While removal of true duplicate reads would be the ideal solution toward correcting for this type of bias, their identification is complicated by the fact that we expect read duplicates to occur in RNA-seq data through independent sampling of RNA fragments. In particular, for genes that are expressed at high levels, it is likely reads with the same start- and end-positions will occur, even though these reads originate from separate RNA fragments and therefore should be counted independently during quantification of expression. Therefore, identfication of true duplicates reads from those originating from independent sampling is not possible in most RNA-seq data, and cannot be done effectively for single-end datasets. 

#### Duplicate removal 

Generally, most people **do not** remove duplicates from their RNA-seq data, as several studies have shown that their presence does not substantially bias differential expression analysis or dramatrically reduce statistical power, [provided the library is sufficiently complex](https://www.nature.com/articles/srep25533). Furthermore, de-duplication could introduce its own form of bias as read duplicates from separate RNA fragments will be incorrectly merged. 

Despite these considerations, there is still value in checking the levels of read duplication among your aligned reads, to ensure extreme levels of duplication do not exist. We can do this with the [**MarkDuplicates**](https://gatk.broadinstitute.org/hc/en-us/articles/360036834611-MarkDuplicates-Picard-) from *Picard Tools*. *MarkDuplicates* works by comparing the coordinates, orientation, and sequence of read pairs in an input SAM/BAM file. Completion of *MarkDuplicates* will generate a text file with the suffix `xxx.markduplicates_metrics.txt` that documents key duplication statistics that can be included in our QC report.  

To run *MarkDuplicates*, we call the jar file for *Picard tools* and specify the input SAM/BAM file. 
```bash 
java -Xmx32G -jar picard.jar \
MarkDuplicates \
I=myInBam \
O=myOutBam \
M=myTxt \
OPTICAL_DUPLICATE_PIXEL_DISTANCE=100 \
CREATE_INDEX=false
```

**Option descriptions**:  
`I`=input aligned bam file  
`O`=output with duplicate reads marked  
`M`=file to write duplication metrics to  
`OPTICAL_DUPLICATE_PIXEL_DISTANCE`= The maximum offset between two duplicate clusters in order to consider them optical duplicates  
`CREATE_INDEX`=(TRUE/FALSE) Whether to create a BAM index when writing a coordinate-sorted BAM file. 

We then just need to make sure the `xxx.markduplicates_metrics.txt` file in included a subdirectory when we run `MultiQC`, and it will be included in the report. 

**Additional note:** If you have very low levels of starting material that will require a lot of PCR amplification, if you plan to sequence **very** deeply, or if removal of true duplicate reads is of particular importance to your experiment, you should consider using a library preparation method that leverages unique molecular identifiers (UMIs), which allow true read duplicates to be effectively identified and removed.  

#### Generating the QC report with MultiQC

Viewing each the output from the aligner, `CollectRNASeqMetrics`, `MarkDuplicates`, etc. would obvbiously be very tideous, so we need some way of aggregating all of these data into one place so that we can compare across the whole dataset. 

`MultiQC` is a very useful tool that synthesizes interactive reports using the output from many commonly used bioinformatics tools. When `MultiQC` is called on a directory, it will search through all subdirectories for file types that it recognizes, and include them in its report. The result is a browsable, sharable, and interactive HTML file containing all of the QC results from our entire dataset. 

`MultiQC` is simply run in the command line by specifying the oparent directory where all of the files you wish to be included in your report are located. Lets run `MultiQC` on a few files to get an idea of how it works, and then look at the full report that has been generated for you with all the samples in the dataset. 

```bash
multiqc . 
```

Locate the qc_report.html file in `RNA-seq_workshop_July2020/misc/` and open it in a web-broswer. 

How does the quality look? Do you think there is cause for concern for any samples? 
